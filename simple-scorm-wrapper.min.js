/**
* @name simple-scorm-wrapper
* @version 0.1.8
* @description Simple SCORM Wrapper for JavaScript
* @author lmihaidaniel <lacatusu.mihai.daniel@gmail.com>
* @license MIT
* */
var Scorm=function(){"use strict";function t(t){return"function"==typeof t||!1}function e(t,e){var i="P",s=t,n=0,o=0,r=0,a=0,c=0;t=Math.max(t,0);var s=t;s=Math.round(s),1==e?r=Math.floor(s/864e4):(n=Math.floor(s/315576e4),s-=315576e4*n,o=Math.floor(s/26298e4),s-=26298e4*o,r=Math.floor(s/864e4)),s-=864e4*r,a=Math.floor(s/36e4),s-=36e4*a;var c=Math.floor(s/6e3);return s-=6e3*c,n>0&&(i+=n+"Y"),o>0&&(i+=o+"M"),r>0&&(i+=r+"D"),(a>0||c>0||s>0)&&(i+="T",a>0&&(i+=a+"H"),c>0&&(i+=c+"M"),s>0&&(i+=s/100+"S")),"P"==i&&(i="PT0H0M0S"),i}function i(t){return!!t&&"object"==typeof t&&1===t.nodeType}function s(t,i){if(void 0===i&&(i="1.2"),"1.2"!=i)return e(100*Math.round(t/1e3),!0);var s=parseInt(t%1e3/100),n=parseInt(t/1e3%60),r=parseInt(t/6e4%60),a=parseInt(t/36e5%24);return a=o(a,4),r=o(r,2),n=o(n,2),a+":"+r+":"+n+"."+s}function n(t,e){return t.indexOf(e)>-1}var o=function(t,e){for(var i=String(t);i.length<e;)i="0"+i;return i},r=function(){var t=function(e,i){if(i){var s=Array.isArray(i),n=s&&[]||{};return s?(e=e||[],n=n.concat(e),i.forEach(function(i,s){"undefined"==typeof n[s]?n[s]=i:"object"==typeof i?n[s]=t(e[s],i):e.indexOf(i)===-1&&n.push(i)})):(e&&"object"==typeof e&&Object.keys(e).forEach(function(t){n[t]=e[t]}),Object.keys(i).forEach(function(s){"object"==typeof i[s]&&i[s]&&e[s]?n[s]=t(e[s],i[s]):n[s]=i[s]})),n}return e=e||[]};return t}(),a=function(){var t=function(e,i){return e>i?t(e/10,i):e};return t}(),c={1.2:{id:"cmi.core.student_id",name:"cmi.core.student_name",language:"cmi.student_preference.language",audio:"cmi.student_preference.audio",location:"cmi.core.lesson_location",credit:"cmi.core.credit",entry:"cmi.core.entry",launch_data:"cmi.launch_data",lesson_mode:"cmi.core.lesson_mode",max_time_allowed:"cmi.student_data.max_time_allowed",session_time:"cmi.core.session_time","score.min":"cmi.core.score.min","score.max":"cmi.core.score.max","score.raw":"cmi.core.score.raw","score.scaled":"cmi.core.score.raw",suspend_data:"cmi.suspend_data",status:"cmi.core.lesson_status",total_time:"cmi.core.total_time"},2004:{id:"cmi.learner_id",name:"cmi.learner_name",language:"cmi.learner_preference.language",audio:"cmi.learner_preference.audio_level",location:"cmi.location",credit:"cmi.credit",entry:"cmi.entry",launch_data:"cmi.launch_data",lesson_mode:"cmi.mode",max_time_allowed:"cmi.max_time_allowed",session_time:"cmi.session_time","score.min":"cmi.score.min","score.max":"cmi.score.max","score.raw":"cmi.score.raw","score.scaled":"cmi.score.scaled",suspend_data:"cmi.suspend_data",status:"cmi.completion_status",total_time:"cmi.total_time"}},l={code:"0",string:"No Error",diagnostic:"No Error"},u={code:"101",string:"General Exception",diagnostic:"General Exception"},h={confirm:!1,label:"Are you sure you want to quit the program ?"},m=["","normal","suspend","logout"],d=function(){},p=function(t){var e={code:l.code,string:l.string,diagnostic:l.diagnostic},i=t.getApiHandle();return null==i?(e.code=u.code,e.string=u.string,e.diagnostic="Unable to locate the LMS's API Implementation. Cannot determine LMS error code.",t.message(e,"Unable to locate the LMS's API Implementation.\nCannot determine LMS error code."),e):(e.code=t.getLastError().toString(),e.code!=l.code&&(e.string=t.getErrorString(e.code),e.diagnostic=t.getDiagnostic("")),e)},f=function(e,i){var s=this;void 0===e&&(e={}),this.version=e.version||null,null!=this.version&&(this.version=this.version.toString()),this.initialized=!1,this.api=null,this.exitValue=e.exitValue||null,this.prefix="",this.completion_status=null,this.message=e.debugger||d,this.finished=!1,this.startTime=(new Date).getTime(),this.idleTime=0,this.window=null,this.scoreMin=null,this.scoreMax=null,this.storage={},this.params=function(t){return c[s.version][t]||""};var n=this.initialize();return"true"!=n?(t(i)&&i.bind(this)(n),!1):(window.onunload=function(t){s.finished||s.terminate()},window.onbeforeunload=function(t){s.finished||s.terminate()},null!=e.score&&(e.score.min||(e.score.min=0),this.scoreMin=a(e.score.min,100),this.setValue(this.params("score.min"),e.score.min),e.score.max||(e.score.max=100),this.scoreMax=a(e.score.max,100),this.setValue(this.params("score.max"),e.score.max)),t(i)&&i.bind(this)(n),this)};return f.prototype.userName=function(){return this.getValue(this.params("name"))},f.prototype.userId=function(){return this.getValue(this.params("id"))},f.prototype.bindCloseToElement=function(t,e){var s=this,n=r(h,e);i(t)&&t.addEventListener("click",function(){var t=!0;if(n.confirm&&(t=!1,t=1==confirm(n.label)),t){var e=s.terminate();"true"==e&&window.top.close()}})},f.prototype.status=function(t){var e="";switch(this.version){case"1.2":e="cmi.core.lesson_status";break;case"2004":e="cmi.completion_status"}if(null!=t){var i={1.2:["not attempted","completed","incomplete","passed","failed","browsed"],2004:["not attempted","completed","incomplete","unknown"]},s=i[this.version];return n(s,t)?this.setValue(e,t):void this.message(l,"status value not supported")}return this.getValue(e)},f.prototype.score=function(t){var e=null;if(null!=t){var i=0;t=a(t,100),"1.2"!=this.version?(i=(t-this.scoreMin)/(this.scoreMax-this.scoreMin),this.setValue(this.params("score.raw"),t),this.setValue("cmi.score.scaled",i)):(i=(t-this.scoreMin)*(100/(this.scoreMax-this.scoreMin)),this.setValue(this.params("score.raw"),i)),t>=this.scoreMax&&("1.2"!=this.version?this.setValue("cmi.success_status","passed"):this.status("passed"))}else e=parseInt(this.getValue(this.params("score.raw")));return e},f.prototype.success=function(t){return null==t?"1.2"!=this.version?this.getValue("cmi.success_status"):this.status():void(t?"1.2"!=this.version?this.setValue("cmi.success_status","passed"):this.status("passed"):"1.2"!=this.version?this.setValue("cmi.success_status","failed"):this.status("failed"))},f.prototype.suspend_data=function(t){if(null==t){var e=this.getValue(this.params("suspend_data"));return e?this.storage=JSON.parse(e):this.setValue(this.params("suspend_data"),JSON.stringify(this.storage)),this.storage}this.storage=r(this.storage,t),this.setValue(this.params("suspend_data"),JSON.stringify(this.storage))},f.prototype.language=function(t){return null==t?this.getValue(this.params("language")):void this.suspend_data({lng:t})},f.prototype.location=function(t){return null!=t&&this.setValue(this.params("location"),t),this.getValue(this.params("location"))},f.prototype.session_time=function(t){if(null!=this.startTime){var e=(new Date).getTime()-this.startTime+this.idleTime;return null!=t&&e>1e3&&this.setValue(this.params("session_time"),s(e,this.version)),s(e,this.version)}},f.prototype.total_time=function(){return this.getValue(this.params("total_time"))},f.prototype.initialize=function(){if(this.initialized)return"true";var t=this.getApiHandle();if(null==t)return this.message(u,"Unable to locate the LMS's API Implementation.\n"+this.prefix+"Initialize was not successful."),"false";var e=this.prefix+"Initialize",i=t[e]("");if("true"!=i.toString()){var s=p(this);this.message(s,e+" failed with error code: "+s.code,"initialize")}else{this.initialized=!0;var n=this.status();if(n)switch(n){case"not attempted":this.status("incomplete");break;case"unknown":this.status("incomplete")}}return i.toString()},f.prototype.beforeTerminate=function(){},f.prototype.terminate=function(e){if(void 0===e&&(e=""),!this.initialized)return"true";var i=this.getApiHandle(),s="false";if(null==i)return this.message(u,"Unable to locate the LMS's API Implementation.\n"+this.prefix+"Finish was not successful."),"false";var o=!1,r=e;"logout"!==e&&"normal"!==e||(r="1.2"===this.version?"logout":"normal"),"completed"!==this.completion_status&&"passed"!==this.completion_status&&(r="suspend"),n(m,this.exitValue)&&(r=this.exitValue),this.session_time("save"),t(this.beforeTerminate)&&this.beforeTerminate(),o=this.commit();var a=d,c="Terminate";if("1.2"===this.version?(o=this.setValue("cmi.core.exit",r),c="LMSFinish",a=function(t){return i.LMSFinish(t)}):(o=this.setValue("cmi.exit",r),c="Terminate",a=function(t){return i.Terminate(t)}),"true"==o&&(s=a(""),"true"!=s.toString())){var l=p(this);this.message(l,c+" failed with error code: "+l.code,"terminate")}return this.initialized=!1,"true"!=this.finished&&(this.finished=s.toString()),s.toString()},f.prototype.getValue=function(t){var e=this.getApiHandle(),i="",s=this.prefix+"GetValue";if(null==e)this.message(u,"Unable to locate the LMS's API Implementation.\nLMSGetValue was not successful.");else if(this.initialized||this.initialize()){i=e[s](t);var n=p(this);if(n.code!=l.code)this.message(n,s+"("+t+") failed. \n"+n.code+": "+n.string,"getValue",t),i="";else switch(t){case"cmi.core.lesson_status":case"cmi.completion_status":this.completion_status=i}}else{var o=p(this);this.message(o,s+" failed - Could not initialize communication with the LMS - error code: "+o.code)}return i.toString()},f.prototype.setValue=function(t,e){var i=this.getApiHandle(),s="false",n=this.prefix+"SetValue";if(null==i)this.message(u,"Unable to locate the LMS's API Implementation.\nLMSSetValue was not successful.");else if(this.initialized||this.initialize())if(s=i[n](t,e),"true"!=s.toString()){var o=p(this);this.message(o,n+"("+t+", "+e+") failed. \n"+o.code+": "+o.string,"setValue",t)}else"cmi.core.lesson_status"!==t&&"cmi.completion_status"!==t||(this.completion_status=e);else{var r=p(this);this.message(r,n+" failed - Could not initialize communication with the LMS - error code: "+r.code)}return s.toString()},f.prototype.commit=function(){var t=this.getApiHandle(),e="false",i=this.prefix+"Commit";if(null==t)this.message(u,"Unable to locate the LMS's API Implementation.\nLMSCommit was not successful.");else if(this.initialized||this.initialize()){if(e=t[i](""),"true"!=e){var s=p(this);this.message(s,i+" failed - error code: "+s.code,"commit")}}else{var n=p(this);this.message(n,i+" failed - Could not initialize communication with the LMS - error code: "+n.code)}return e.toString()},f.prototype.getLastError=function(){var t=this.getApiHandle();return null==t?u.code:t[this.prefix+"GetLastError"]().toString()},f.prototype.getErrorString=function(t){var e=this.getApiHandle();return null==e?u.string:e[this.prefix+"GetErrorString"](t).toString()},f.prototype.getDiagnostic=function(t){var e=this.getApiHandle();return null==e?"Unable to locate the LMS's API Implementation. LMSGetDiagnostic was not successful.":e[this.prefix+"GetDiagnostic"](t).toString()},f.prototype.getApiHandle=function(){return null==this.api&&(this.api=this.getApi()),this.api},f.prototype.findAPI=function(t){for(var e=null,i=0;!t.API&&!t.API_1484_11&&t.parent&&t.parent!=t&&i<=500;)i++,t=t.parent;if(this.window=t,null!=t.API_1484_11&&null!=t.API&&null!=this.version)"1.2"==this.version&&(this.prefix="LMS",e=t.API),"2004"==this.version&&(this.prefix="",e=t.API_1484_11);else{if(t.API_1484_11)return this.version="2004",this.prefix="",t.API_1484_11;if(t.API)return this.version="1.2",this.prefix="LMS",t.API}return e},f.prototype.getApi=function(){var t=this.findAPI(window);return!t&&window.parent&&window.parent!=window&&(t=this.findAPI(window.parent)),!t&&window.opener&&window.opener&&(t=this.findAPI(window.opener)),!t&&window.top&&window.top.opener&&(t=findAPI(window.top.opener)),!t&&window.top&&window.top.opener&&window.top.opener.document&&(t=findAPI(window.top.opener.document)),t},f.prototype.findObjective=function(t){var e=this;if("2004"===this.version){for(var i=this.getValue("cmi.objectives._count"),s=-1,n=0;n<i;++n)if(e.getValue("cmi.objectives."+n+".id")==t){s=n;break}return s==-1&&(this.message(u,"Objective "+t+" not found."),s=i,this.message(u,"Creating new objective at index "+s),this.setValue("cmi.objectives."+s+".id",t)),s}},f.prototype.findDataStore=function(t){var e=this;if("2004"===this.version){var i=this.getValue("adl.data._count"),s=-1;if(null!=i&&!isNaN(i)){for(var n=0;n<i;++n)if(e.getValue("adl.data."+n+".id")==t){s=n;break}s==-1&&this.message(u,"Data store "+t+" not found.")}return s}},f}();
