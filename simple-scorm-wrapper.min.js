/**
* @name simple-scorm-wrapper
* @version 0.1.9
* @description Simple SCORM Wrapper for JavaScript
* @author lmihaidaniel <lacatusu.mihai.daniel@gmail.com>
* @license MIT
* */
var Scorm=function(){"use strict";var t=function(t,e){for(var i=String(t);i.length<e;)i="0"+i;return i};function e(t){return"function"==typeof t||!1}function i(e,i){if(void 0===i&&(i="1.2"),"1.2"!=i)return function(t,e){var i="P",s=t,n=0,o=0,r=0,a=0,c=0;return s=t=Math.max(t,0),s=Math.round(s),1==e?r=Math.floor(s/864e4):(s-=315576e4*(n=Math.floor(s/315576e4)),s-=26298e4*(o=Math.floor(s/26298e4)),r=Math.floor(s/864e4)),s-=864e4*r,s-=36e4*(a=Math.floor(s/36e4)),s-=6e3*(c=Math.floor(s/6e3)),n>0&&(i+=n+"Y"),o>0&&(i+=o+"M"),r>0&&(i+=r+"D"),(a>0||c>0||s>0)&&(i+="T",a>0&&(i+=a+"H"),c>0&&(i+=c+"M"),s>0&&(i+=s/100+"S")),"P"==i&&(i="PT0H0M0S"),i}(100*Math.round(e/1e3),!0);var s=parseInt(e%1e3/100),n=parseInt(e/1e3%60),o=parseInt(e/6e4%60),r=parseInt(e/36e5%24);return(r=t(r,4))+":"+(o=t(o,2))+":"+(n=t(n,2))+"."+s}function s(t,e){return t.indexOf(e)>-1}var n=function(){var t=function(e,i){if(i){var s=Array.isArray(i),n=s&&[]||{};return s?(e=e||[],n=n.concat(e),i.forEach(function(i,s){void 0===n[s]?n[s]=i:"object"==typeof i?n[s]=t(e[s],i):-1===e.indexOf(i)&&n.push(i)})):(e&&"object"==typeof e&&Object.keys(e).forEach(function(t){n[t]=e[t]}),Object.keys(i).forEach(function(s){"object"==typeof i[s]&&i[s]&&e[s]?n[s]=t(e[s],i[s]):n[s]=i[s]})),n}return e=e||[]};return t}(),o=function(){var t=function(e,i){return e>i?t(e/10,i):e};return t}(),r={1.2:{id:"cmi.core.student_id",name:"cmi.core.student_name",language:"cmi.student_preference.language",audio:"cmi.student_preference.audio",location:"cmi.core.lesson_location",credit:"cmi.core.credit",entry:"cmi.core.entry",launch_data:"cmi.launch_data",lesson_mode:"cmi.core.lesson_mode",max_time_allowed:"cmi.student_data.max_time_allowed",session_time:"cmi.core.session_time","score.min":"cmi.core.score.min","score.max":"cmi.core.score.max","score.raw":"cmi.core.score.raw","score.scaled":"cmi.core.score.raw",suspend_data:"cmi.suspend_data",status:"cmi.core.lesson_status",total_time:"cmi.core.total_time"},2004:{id:"cmi.learner_id",name:"cmi.learner_name",language:"cmi.learner_preference.language",audio:"cmi.learner_preference.audio_level",location:"cmi.location",credit:"cmi.credit",entry:"cmi.entry",launch_data:"cmi.launch_data",lesson_mode:"cmi.mode",max_time_allowed:"cmi.max_time_allowed",session_time:"cmi.session_time","score.min":"cmi.score.min","score.max":"cmi.score.max","score.raw":"cmi.score.raw","score.scaled":"cmi.score.scaled",suspend_data:"cmi.suspend_data",status:"cmi.completion_status",total_time:"cmi.total_time"}},a={code:"0",string:"No Error",diagnostic:"No Error"},c={code:"101",string:"General Exception",diagnostic:"General Exception"},l={confirm:!1,label:"Are you sure you want to quit the program ?"},u=["","normal","suspend","logout"],h=function(){},m=function(t){var e={code:a.code,string:a.string,diagnostic:a.diagnostic};return null==t.getApiHandle()?(e.code=c.code,e.string=c.string,e.diagnostic="Unable to locate the LMS's API Implementation. Cannot determine LMS error code.",t.message(e,"Unable to locate the LMS's API Implementation.\nCannot determine LMS error code."),e):(e.code=t.getLastError().toString(),e.code!=a.code&&(e.string=t.getErrorString(e.code),e.diagnostic=t.getDiagnostic("")),e)},d=function(t,i){var s=this;void 0===t&&(t={}),this.version=t.version||null,null!=this.version&&(this.version=this.version.toString()),this.initialized=!1,this.api=null,this.exitValue=t.exitValue||null,this.prefix="",this.completion_status=null,this.message=t.debugger||h,this.finished=!1,this.startTime=(new Date).getTime(),this.idleTime=0,this.window=null,this.scoreMin=null,this.scoreMax=null,this.storage={},this.params=function(t){return r[s.version][t]||""};var n=this.initialize();return"true"!=n?(e(i)&&i.bind(this)(n),!1):(window.onunload=function(t){s.finished||s.terminate()},window.onbeforeunload=function(t){s.finished||s.terminate()},null!=t.score&&(t.score.min||(t.score.min=0),this.scoreMin=o(t.score.min,100),this.setValue(this.params("score.min"),t.score.min),t.score.max||(t.score.max=100),this.scoreMax=o(t.score.max,100),this.setValue(this.params("score.max"),t.score.max)),e(i)&&i.bind(this)(n),this)};return d.prototype.userName=function(){return this.getValue(this.params("name"))},d.prototype.userId=function(){return this.getValue(this.params("id"))},d.prototype.bindCloseToElement=function(t,e){var i=this,s=n(l,e);(o=t)&&"object"==typeof o&&1===o.nodeType&&t.addEventListener("click",function(){var t=!0;if(s.confirm&&(t=!1,t=1==confirm(s.label)),t){"true"==i.terminate()&&window.top.close()}});var o},d.prototype.status=function(t){var e="";switch(this.version){case"1.2":e="cmi.core.lesson_status";break;case"2004":e="cmi.completion_status"}if(null!=t){return s({1.2:["not attempted","completed","incomplete","passed","failed","browsed"],2004:["not attempted","completed","incomplete","unknown"]}[this.version],t)?this.setValue(e,t):void this.message(a,"status value not supported")}return this.getValue(e)},d.prototype.score=function(t){var e=null;if(null!=t){var i=0;t=o(t,100),"1.2"!=this.version?(i=(t-this.scoreMin)/(this.scoreMax-this.scoreMin),this.setValue(this.params("score.raw"),t),this.setValue("cmi.score.scaled",i)):(i=(t-this.scoreMin)*(100/(this.scoreMax-this.scoreMin)),this.setValue(this.params("score.raw"),i)),t>=this.scoreMax&&("1.2"!=this.version?this.setValue("cmi.success_status","passed"):this.status("passed"))}else e=parseInt(this.getValue(this.params("score.raw")));return e},d.prototype.success=function(t){if(null==t)return"1.2"!=this.version?this.getValue("cmi.success_status"):this.status();t?"1.2"!=this.version?this.setValue("cmi.success_status","passed"):this.status("passed"):"1.2"!=this.version?this.setValue("cmi.success_status","failed"):this.status("failed")},d.prototype.suspend_data=function(t){if(null==t){var e=this.getValue(this.params("suspend_data"));return e?this.storage=JSON.parse(e):this.setValue(this.params("suspend_data"),JSON.stringify(this.storage)),this.storage}this.storage=n(this.storage,t),this.setValue(this.params("suspend_data"),JSON.stringify(this.storage))},d.prototype.language=function(t){if(null==t)return this.getValue(this.params("language"));this.suspend_data({lng:t})},d.prototype.location=function(t){return null!=t&&this.setValue(this.params("location"),t),this.getValue(this.params("location"))},d.prototype.session_time=function(t){if(null!=this.startTime){var e=(new Date).getTime()-this.startTime+this.idleTime;return null!=t&&e>1e3&&this.setValue(this.params("session_time"),i(e,this.version)),i(e,this.version)}},d.prototype.total_time=function(){return this.getValue(this.params("total_time"))},d.prototype.initialize=function(){if(this.initialized)return"true";var t=this.getApiHandle();if(null==t)return this.message(c,"Unable to locate the LMS's API Implementation.\n"+this.prefix+"Initialize was not successful."),"false";var e=this.prefix+"Initialize",i=t[e]("");if("true"!=i.toString()){var s=m(this);this.message(s,e+" failed with error code: "+s.code,"initialize")}else{this.initialized=!0;var n=this.status();if(n)switch(n){case"not attempted":case"unknown":this.status("incomplete")}}return i.toString()},d.prototype.beforeTerminate=function(){},d.prototype.terminate=function(t){if(void 0===t&&(t=""),!this.initialized)return"true";var i=this.getApiHandle(),n="false";if(null==i)return this.message(c,"Unable to locate the LMS's API Implementation.\n"+this.prefix+"Finish was not successful."),"false";var o=!1,r=t;"logout"!==t&&"normal"!==t||(r="1.2"===this.version?"logout":"normal"),"completed"!==this.completion_status&&"passed"!==this.completion_status&&(r="suspend"),s(u,this.exitValue)&&(r=this.exitValue),this.session_time("save"),e(this.beforeTerminate)&&this.beforeTerminate(),o=this.commit();var a=h,l="Terminate";if("1.2"===this.version?(o=this.setValue("cmi.core.exit",r),l="LMSFinish",a=function(t){return i.LMSFinish(t)}):(o=this.setValue("cmi.exit",r),l="Terminate",a=function(t){return i.Terminate(t)}),"true"==o&&"true"!=(n=a("")).toString()){var d=m(this);this.message(d,l+" failed with error code: "+d.code,"terminate")}return this.initialized=!1,"true"!=this.finished&&(this.finished=n.toString()),n.toString()},d.prototype.getValue=function(t){var e=this.getApiHandle(),i="",s=this.prefix+"GetValue";if(null==e)this.message(c,"Unable to locate the LMS's API Implementation.\nLMSGetValue was not successful.");else if(this.initialized||this.initialize()){i=e[s](t);var n=m(this);if(n.code!=a.code)this.message(n,s+"("+t+") failed. \n"+n.code+": "+n.string,"getValue",t),i="";else switch(t){case"cmi.core.lesson_status":case"cmi.completion_status":this.completion_status=i}}else{var o=m(this);this.message(o,s+" failed - Could not initialize communication with the LMS - error code: "+o.code)}return i.toString()},d.prototype.setValue=function(t,e){var i=this.getApiHandle(),s="false",n=this.prefix+"SetValue";if(null==i)this.message(c,"Unable to locate the LMS's API Implementation.\nLMSSetValue was not successful.");else if(this.initialized||this.initialize())if("true"!=(s=i[n](t,e)).toString()){var o=m(this);this.message(o,n+"("+t+", "+e+") failed. \n"+o.code+": "+o.string,"setValue",t)}else"cmi.core.lesson_status"!==t&&"cmi.completion_status"!==t||(this.completion_status=e);else{var r=m(this);this.message(r,n+" failed - Could not initialize communication with the LMS - error code: "+r.code)}return s.toString()},d.prototype.commit=function(){var t=this.getApiHandle(),e="false",i=this.prefix+"Commit";if(null==t)this.message(c,"Unable to locate the LMS's API Implementation.\nLMSCommit was not successful.");else if(this.initialized||this.initialize()){if("true"!=(e=t[i](""))){var s=m(this);this.message(s,i+" failed - error code: "+s.code,"commit")}}else{var n=m(this);this.message(n,i+" failed - Could not initialize communication with the LMS - error code: "+n.code)}return e.toString()},d.prototype.getLastError=function(){var t=this.getApiHandle();return null==t?c.code:t[this.prefix+"GetLastError"]().toString()},d.prototype.getErrorString=function(t){var e=this.getApiHandle();return null==e?c.string:e[this.prefix+"GetErrorString"](t).toString()},d.prototype.getDiagnostic=function(t){var e=this.getApiHandle();return null==e?"Unable to locate the LMS's API Implementation. LMSGetDiagnostic was not successful.":e[this.prefix+"GetDiagnostic"](t).toString()},d.prototype.getApiHandle=function(){return null==this.api&&(this.api=this.getApi()),this.api},d.prototype.findAPI=function(t){for(var e=null,i=0;!t.API&&!t.API_1484_11&&t.parent&&t.parent!=t&&i<=500;)i++,t=t.parent;return this.window=t,null!=t.API_1484_11&&null!=t.API&&null!=this.version?("1.2"==this.version&&(this.prefix="LMS",e=t.API),"2004"==this.version&&(this.prefix="",e=t.API_1484_11)):t.API_1484_11?(this.version="2004",this.prefix="",e=t.API_1484_11):t.API&&(this.version="1.2",this.prefix="LMS",e=t.API),e},d.prototype.getApi=function(){var t=this.findAPI(window);return!t&&window.parent&&window.parent!=window&&(t=this.findAPI(window.parent)),!t&&window.opener&&window.opener&&(t=this.findAPI(window.opener)),!t&&window.top&&window.top.opener&&(t=this.findAPI(window.top.opener)),!t&&window.top&&window.top.opener&&window.top.opener.document&&(t=this.findAPI(window.top.opener.document)),t},d.prototype.findObjective=function(t){if("2004"===this.version){for(var e=this.getValue("cmi.objectives._count"),i=-1,s=0;s<e;++s)if(this.getValue("cmi.objectives."+s+".id")==t){i=s;break}return-1==i&&(this.message(c,"Objective "+t+" not found."),i=e,this.message(c,"Creating new objective at index "+i),this.setValue("cmi.objectives."+i+".id",t)),i}},d.prototype.findDataStore=function(t){if("2004"===this.version){var e=this.getValue("adl.data._count"),i=-1;if(null!=e&&!isNaN(e)){for(var s=0;s<e;++s)if(this.getValue("adl.data."+s+".id")==t){i=s;break}-1==i&&this.message(c,"Data store "+t+" not found.")}return i}},d}();
